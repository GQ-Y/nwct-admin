package display

import (
	"image"
	"image/color"
	"image/draw"

	"github.com/golang/freetype"
	"github.com/golang/freetype/truetype"
	"golang.org/x/image/math/fixed"
)

// Graphics 图形绘制库
type Graphics struct {
	buffer *image.RGBA
}

// NewGraphics 创建图形库实例
func NewGraphics(buffer *image.RGBA) *Graphics {
	return &Graphics{
		buffer: buffer,
	}
}

// Clear 清空画布
func (g *Graphics) Clear(c color.Color) {
	draw.Draw(g.buffer, g.buffer.Bounds(), &image.Uniform{c}, image.Point{}, draw.Src)
}

// DrawRect 绘制矩形
func (g *Graphics) DrawRect(x, y, w, h int, c color.Color) {
	rect := image.Rect(x, y, x+w, y+h)
	draw.Draw(g.buffer, rect, &image.Uniform{c}, image.Point{}, draw.Src)
}

// DrawRectRounded 绘制圆角矩形
func (g *Graphics) DrawRectRounded(x, y, w, h, radius int, c color.Color) {
	// 绘制中心矩形
	g.DrawRect(x+radius, y, w-2*radius, h, c)
	g.DrawRect(x, y+radius, w, h-2*radius, c)

	// 绘制四个圆角
	g.drawFilledCircleCorner(x+radius, y+radius, radius, c, 2)     // 左上
	g.drawFilledCircleCorner(x+w-radius, y+radius, radius, c, 1)   // 右上
	g.drawFilledCircleCorner(x+radius, y+h-radius, radius, c, 3)   // 左下
	g.drawFilledCircleCorner(x+w-radius, y+h-radius, radius, c, 4) // 右下
}

// drawFilledCircleCorner 绘制圆角（四分之一圆）
func (g *Graphics) drawFilledCircleCorner(cx, cy, r int, c color.Color, quadrant int) {
	for dy := -r; dy <= r; dy++ {
		for dx := -r; dx <= r; dx++ {
			if dx*dx+dy*dy <= r*r {
				var px, py int
				switch quadrant {
				case 1: // 右上
					if dx >= 0 && dy <= 0 {
						px, py = cx+dx, cy+dy
					} else {
						continue
					}
				case 2: // 左上
					if dx <= 0 && dy <= 0 {
						px, py = cx+dx, cy+dy
					} else {
						continue
					}
				case 3: // 左下
					if dx <= 0 && dy >= 0 {
						px, py = cx+dx, cy+dy
					} else {
						continue
					}
				case 4: // 右下
					if dx >= 0 && dy >= 0 {
						px, py = cx+dx, cy+dy
					} else {
						continue
					}
				}

				if px >= 0 && px < g.buffer.Bounds().Dx() && py >= 0 && py < g.buffer.Bounds().Dy() {
					g.buffer.Set(px, py, c)
				}
			}
		}
	}
}

// DrawCircle 绘制实心圆
func (g *Graphics) DrawCircle(cx, cy, r int, c color.Color) {
	for y := cy - r; y <= cy+r; y++ {
		for x := cx - r; x <= cx+r; x++ {
			dx := x - cx
			dy := y - cy
			if dx*dx+dy*dy <= r*r {
				if x >= 0 && x < g.buffer.Bounds().Dx() && y >= 0 && y < g.buffer.Bounds().Dy() {
					g.buffer.Set(x, y, c)
				}
			}
		}
	}
}

// GradientDirection 渐变方向
type GradientDirection int

const (
	GradientVertical GradientDirection = iota
	GradientHorizontal
)

// DrawGradient 绘制渐变
func (g *Graphics) DrawGradient(x, y, w, h int, colors []color.Color, direction GradientDirection) {
	if len(colors) < 2 {
		return
	}

	for py := 0; py < h; py++ {
		for px := 0; px < w; px++ {
			var t float64
			if direction == GradientVertical {
				t = float64(py) / float64(h)
			} else {
				t = float64(px) / float64(w)
			}

			// 计算当前位置在哪两个颜色之间
			segmentCount := len(colors) - 1
			segment := t * float64(segmentCount)
			segmentIndex := int(segment)
			if segmentIndex >= segmentCount {
				segmentIndex = segmentCount - 1
			}

			localT := segment - float64(segmentIndex)

			c1 := colors[segmentIndex]
			c2 := colors[segmentIndex+1]

			r1, g1, b1, a1 := c1.RGBA()
			r2, g2, b2, a2 := c2.RGBA()

			r := uint8((float64(r1>>8)*(1-localT) + float64(r2>>8)*localT))
			gb := uint8((float64(g1>>8)*(1-localT) + float64(g2>>8)*localT))
			b := uint8((float64(b1>>8)*(1-localT) + float64(b2>>8)*localT))
			a := uint8((float64(a1>>8)*(1-localT) + float64(a2>>8)*localT))

			finalX, finalY := x+px, y+py
			if finalX >= 0 && finalX < g.buffer.Bounds().Dx() && finalY >= 0 && finalY < g.buffer.Bounds().Dy() {
				g.buffer.Set(finalX, finalY, color.RGBA{r, gb, b, a})
			}
		}
	}
}

// DrawText 绘制文本（简单位图字体）
func (g *Graphics) DrawText(text string, x, y int, c color.Color, size int) {
	// 使用简单的 8x8 位图字体
	for i, ch := range text {
		g.drawChar(ch, x+i*size, y, c, size)
	}
}

// DrawTextTTF 使用 TrueType 字体绘制文本
func (g *Graphics) DrawTextTTF(text string, x, y int, c color.Color, size float64, weight FontWeight) error {
	fm := GetFontManager()
	ttfFont := fm.GetFont(weight)
	
	if ttfFont == nil {
		// 回退到位图字体
		g.DrawText(text, x, y, c, int(size))
		return nil
	}

	// 创建 freetype context
	ctx := freetype.NewContext()
	ctx.SetDPI(72)
	ctx.SetFont(ttfFont)
	ctx.SetFontSize(size)
	ctx.SetClip(g.buffer.Bounds())
	ctx.SetDst(g.buffer)
	ctx.SetSrc(&image.Uniform{c})

	// 绘制文本
	pt := freetype.Pt(x, y+int(size))
	_, err := ctx.DrawString(text, pt)
	
	return err
}

// MeasureText 测量文本宽度
func (g *Graphics) MeasureText(text string, size float64, weight FontWeight) int {
	fm := GetFontManager()
	ttfFont := fm.GetFont(weight)
	
	if ttfFont == nil {
		// 回退到位图字体估算
		return len(text) * int(size) / 2
	}

	face := truetype.NewFace(ttfFont, &truetype.Options{
		Size: size,
		DPI:  72,
	})
	defer face.Close()

	width := fixed.Int26_6(0)
	for _, ch := range text {
		advance, ok := face.GlyphAdvance(ch)
		if !ok {
			width += fixed.Int26_6(int(size) * 64 / 2) // 估算
			continue
		}
		width += advance
	}

	return int(width >> 6)
}

// drawChar 绘制单个字符
func (g *Graphics) drawChar(ch rune, x, y int, c color.Color, size int) {
	if ch < 32 || ch > 126 {
		ch = '?' // 不支持的字符显示为 ?
	}

}

// 简单的 8x8 ASCII 位图字体
var font8x8 = [95][8]byte{
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // Space
	{0x18, 0x3C, 0x3C, 0x18, 0x18, 0x00, 0x18, 0x00}, // !
	{0x36, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // "
	{0x36, 0x36, 0x7F, 0x36, 0x7F, 0x36, 0x36, 0x00}, // #
	{0x0C, 0x3E, 0x03, 0x1E, 0x30, 0x1F, 0x0C, 0x00}, // $
	{0x00, 0x63, 0x33, 0x18, 0x0C, 0x66, 0x63, 0x00}, // %
	{0x1C, 0x36, 0x1C, 0x6E, 0x3B, 0x33, 0x6E, 0x00}, // &
	{0x06, 0x06, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00}, // '
	{0x18, 0x0C, 0x06, 0x06, 0x06, 0x0C, 0x18, 0x00}, // (
	{0x06, 0x0C, 0x18, 0x18, 0x18, 0x0C, 0x06, 0x00}, // )
	{0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00}, // *
	{0x00, 0x0C, 0x0C, 0x3F, 0x0C, 0x0C, 0x00, 0x00}, // +
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x06}, // ,
	{0x00, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x00, 0x00}, // -
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x00}, // .
	{0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x01, 0x00}, // /
	{0x3E, 0x63, 0x73, 0x7B, 0x6F, 0x67, 0x3E, 0x00}, // 0
	{0x0C, 0x0E, 0x0C, 0x0C, 0x0C, 0x0C, 0x3F, 0x00}, // 1
	{0x1E, 0x33, 0x30, 0x1C, 0x06, 0x33, 0x3F, 0x00}, // 2
	{0x1E, 0x33, 0x30, 0x1C, 0x30, 0x33, 0x1E, 0x00}, // 3
	{0x38, 0x3C, 0x36, 0x33, 0x7F, 0x30, 0x78, 0x00}, // 4
	{0x3F, 0x03, 0x1F, 0x30, 0x30, 0x33, 0x1E, 0x00}, // 5
	{0x1C, 0x06, 0x03, 0x1F, 0x33, 0x33, 0x1E, 0x00}, // 6
	{0x3F, 0x33, 0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x00}, // 7
	{0x1E, 0x33, 0x33, 0x1E, 0x33, 0x33, 0x1E, 0x00}, // 8
	{0x1E, 0x33, 0x33, 0x3E, 0x30, 0x18, 0x0E, 0x00}, // 9
	{0x00, 0x0C, 0x0C, 0x00, 0x00, 0x0C, 0x0C, 0x00}, // :
	{0x00, 0x0C, 0x0C, 0x00, 0x00, 0x0C, 0x0C, 0x06}, // ;
	{0x18, 0x0C, 0x06, 0x03, 0x06, 0x0C, 0x18, 0x00}, // <
	{0x00, 0x00, 0x3F, 0x00, 0x00, 0x3F, 0x00, 0x00}, // =
	{0x06, 0x0C, 0x18, 0x30, 0x18, 0x0C, 0x06, 0x00}, // >
	{0x1E, 0x33, 0x30, 0x18, 0x0C, 0x00, 0x0C, 0x00}, // ?
	{0x3E, 0x63, 0x7B, 0x7B, 0x7B, 0x03, 0x1E, 0x00}, // @
	{0x0C, 0x1E, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x00}, // A
	{0x3F, 0x66, 0x66, 0x3E, 0x66, 0x66, 0x3F, 0x00}, // B
	{0x3C, 0x66, 0x03, 0x03, 0x03, 0x66, 0x3C, 0x00}, // C
	{0x1F, 0x36, 0x66, 0x66, 0x66, 0x36, 0x1F, 0x00}, // D
	{0x7F, 0x46, 0x16, 0x1E, 0x16, 0x46, 0x7F, 0x00}, // E
	{0x7F, 0x46, 0x16, 0x1E, 0x16, 0x06, 0x0F, 0x00}, // F
	{0x3C, 0x66, 0x03, 0x03, 0x73, 0x66, 0x7C, 0x00}, // G
	{0x33, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x33, 0x00}, // H
	{0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E, 0x00}, // I
	{0x78, 0x30, 0x30, 0x30, 0x33, 0x33, 0x1E, 0x00}, // J
	{0x67, 0x66, 0x36, 0x1E, 0x36, 0x66, 0x67, 0x00}, // K
	{0x0F, 0x06, 0x06, 0x06, 0x46, 0x66, 0x7F, 0x00}, // L
	{0x63, 0x77, 0x7F, 0x7F, 0x6B, 0x63, 0x63, 0x00}, // M
	{0x63, 0x67, 0x6F, 0x7B, 0x73, 0x63, 0x63, 0x00}, // N
	{0x1C, 0x36, 0x63, 0x63, 0x63, 0x36, 0x1C, 0x00}, // O
	{0x3F, 0x66, 0x66, 0x3E, 0x06, 0x06, 0x0F, 0x00}, // P
	{0x1E, 0x33, 0x33, 0x33, 0x3B, 0x1E, 0x38, 0x00}, // Q
	{0x3F, 0x66, 0x66, 0x3E, 0x36, 0x66, 0x67, 0x00}, // R
	{0x1E, 0x33, 0x07, 0x0E, 0x38, 0x33, 0x1E, 0x00}, // S
	{0x3F, 0x2D, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E, 0x00}, // T
	{0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x3F, 0x00}, // U
	{0x33, 0x33, 0x33, 0x33, 0x33, 0x1E, 0x0C, 0x00}, // V
	{0x63, 0x63, 0x63, 0x6B, 0x7F, 0x77, 0x63, 0x00}, // W
	{0x63, 0x63, 0x36, 0x1C, 0x1C, 0x36, 0x63, 0x00}, // X
	{0x33, 0x33, 0x33, 0x1E, 0x0C, 0x0C, 0x1E, 0x00}, // Y
	{0x7F, 0x63, 0x31, 0x18, 0x4C, 0x66, 0x7F, 0x00}, // Z
	{0x1E, 0x06, 0x06, 0x06, 0x06, 0x06, 0x1E, 0x00}, // [
	{0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x40, 0x00}, // \
	{0x1E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x1E, 0x00}, // ]
	{0x08, 0x1C, 0x36, 0x63, 0x00, 0x00, 0x00, 0x00}, // ^
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF}, // _
	{0x0C, 0x0C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00}, // `
	{0x00, 0x00, 0x1E, 0x30, 0x3E, 0x33, 0x6E, 0x00}, // a
	{0x07, 0x06, 0x06, 0x3E, 0x66, 0x66, 0x3B, 0x00}, // b
	{0x00, 0x00, 0x1E, 0x33, 0x03, 0x33, 0x1E, 0x00}, // c
	{0x38, 0x30, 0x30, 0x3e, 0x33, 0x33, 0x6E, 0x00}, // d
	{0x00, 0x00, 0x1E, 0x33, 0x3f, 0x03, 0x1E, 0x00}, // e
	{0x1C, 0x36, 0x06, 0x0f, 0x06, 0x06, 0x0F, 0x00}, // f
	{0x00, 0x00, 0x6E, 0x33, 0x33, 0x3E, 0x30, 0x1F}, // g
	{0x07, 0x06, 0x36, 0x6E, 0x66, 0x66, 0x67, 0x00}, // h
	{0x0C, 0x00, 0x0E, 0x0C, 0x0C, 0x0C, 0x1E, 0x00}, // i
	{0x30, 0x00, 0x30, 0x30, 0x30, 0x33, 0x33, 0x1E}, // j
	{0x07, 0x06, 0x66, 0x36, 0x1E, 0x36, 0x67, 0x00}, // k
	{0x0E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E, 0x00}, // l
	{0x00, 0x00, 0x33, 0x7F, 0x7F, 0x6B, 0x63, 0x00}, // m
	{0x00, 0x00, 0x1F, 0x33, 0x33, 0x33, 0x33, 0x00}, // n
	{0x00, 0x00, 0x1E, 0x33, 0x33, 0x33, 0x1E, 0x00}, // o
	{0x00, 0x00, 0x3B, 0x66, 0x66, 0x3E, 0x06, 0x0F}, // p
	{0x00, 0x00, 0x6E, 0x33, 0x33, 0x3E, 0x30, 0x78}, // q
	{0x00, 0x00, 0x3B, 0x6E, 0x66, 0x06, 0x0F, 0x00}, // r
	{0x00, 0x00, 0x3E, 0x03, 0x1E, 0x30, 0x1F, 0x00}, // s
	{0x08, 0x0C, 0x3E, 0x0C, 0x0C, 0x2C, 0x18, 0x00}, // t
	{0x00, 0x00, 0x33, 0x33, 0x33, 0x33, 0x6E, 0x00}, // u
	{0x00, 0x00, 0x33, 0x33, 0x33, 0x1E, 0x0C, 0x00}, // v
	{0x00, 0x00, 0x63, 0x6B, 0x7F, 0x7F, 0x36, 0x00}, // w
	{0x00, 0x00, 0x63, 0x36, 0x1C, 0x36, 0x63, 0x00}, // x
	{0x00, 0x00, 0x33, 0x33, 0x33, 0x3E, 0x30, 0x1F}, // y
	{0x00, 0x00, 0x3F, 0x19, 0x0C, 0x26, 0x3F, 0x00}, // z
	{0x38, 0x0C, 0x0C, 0x07, 0x0C, 0x0C, 0x38, 0x00}, // {
	{0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x00}, // |
	{0x07, 0x0C, 0x0C, 0x38, 0x0C, 0x0C, 0x07, 0x00}, // }
	{0x6E, 0x3B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // ~
}
