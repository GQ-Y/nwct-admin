<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Totoro Bridge Admin（临时）</title>
    <style>
      :root{
        --bg:#0b1020; --card:rgba(255,255,255,.06); --card2:rgba(255,255,255,.08);
        --text:#e5e7eb; --muted:#9ca3af; --line:rgba(255,255,255,.14);
        --primary:#5b8cff; --danger:#ef4444; --ok:#34d399; --warn:#f59e0b;
        --radius:14px;
      }
      *{box-sizing:border-box}
      body{margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; background:radial-gradient(1200px 600px at 20% 0%, rgba(91,140,255,.25), transparent 60%), radial-gradient(900px 500px at 100% 0%, rgba(52,211,153,.18), transparent 55%), var(--bg); color:var(--text);}
      .wrap{max-width:1100px; margin:0 auto; padding:24px 16px 60px;}
      .top{display:flex; gap:14px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:14px;}
      h1{font-size:18px; margin:0; letter-spacing:.2px}
      .hint{color:var(--muted); font-size:12px}
      .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:14px 14px;}
      .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
      input, textarea, select{background:rgba(255,255,255,.06); border:1px solid var(--line); color:var(--text); padding:10px 12px; border-radius:12px; outline:none;}
      input::placeholder, textarea::placeholder{color:rgba(229,231,235,.45)}
      textarea{width:100%; min-height:110px; resize:vertical;}
      .btn{border:1px solid var(--line); background:rgba(255,255,255,.08); color:var(--text); padding:10px 12px; border-radius:999px; cursor:pointer; font-weight:700; font-size:13px;}
      .btn.primary{background:rgba(91,140,255,.18); border-color:rgba(91,140,255,.35)}
      .btn.danger{background:rgba(239,68,68,.14); border-color:rgba(239,68,68,.35)}
      .btn.ghost{background:transparent}
      .btn:disabled{opacity:.6; cursor:not-allowed}
      .pill{font-size:12px; padding:3px 8px; border-radius:999px; display:inline-flex; align-items:center; gap:6px; border:1px solid var(--line); color:var(--muted)}
      .pill.ok{color:var(--ok); border-color:rgba(52,211,153,.35); background:rgba(52,211,153,.10)}
      .pill.off{color:rgba(239,68,68,.9); border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.10)}
      table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden;}
      th, td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08); font-size:13px; text-align:left; vertical-align:middle;}
      th{color:rgba(229,231,235,.9); font-size:12px; text-transform:uppercase; letter-spacing:.08em; background:rgba(255,255,255,.04)}
      tr:hover td{background:rgba(255,255,255,.03)}
      .tools{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin:10px 0;}
      .toast{margin-top:10px; font-size:13px; font-weight:700}
      .toast.ok{color:var(--ok)} .toast.err{color:rgba(239,68,68,.95)} .toast.warn{color:var(--warn)}
      .modalOverlay{position:fixed; inset:0; background:rgba(0,0,0,.35); backdrop-filter:blur(10px); display:flex; align-items:center; justify-content:center; padding:18px;}
      .modal{width:560px; max-width:100%; background:rgba(15,23,42,.92); border:1px solid rgba(255,255,255,.16); border-radius:18px; box-shadow:0 18px 60px rgba(0,0,0,.55); padding:16px;}
      .modalHeader{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;}
      .modalTitle{font-weight:900; font-size:16px;}
      .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
      @media (max-width: 640px){ .grid2{grid-template-columns:1fr;} }
      code{color:rgba(229,231,235,.9); background:rgba(255,255,255,.08); padding:2px 6px; border-radius:8px;}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="top">
        <div>
          <h1>Totoro Bridge Admin（临时）</h1>
          <div class="hint">临时管理台：设备白名单、官方内置节点配置。所有请求通过 <code>X-Admin-Key</code> 鉴权。</div>
        </div>
        <div class="row">
          <input id="adminKey" placeholder="输入 AdminKey（会本地保存）" style="min-width:260px" />
          <button class="btn primary" id="saveKeyBtn">保存</button>
          <button class="btn" id="refreshBtn">刷新</button>
        </div>
      </div>

      <div class="row" style="margin: 10px 0 14px">
        <button class="btn primary" id="tabDevices">设备白名单</button>
        <button class="btn" id="tabOfficial">官方内置节点</button>
      </div>

      <div class="card" id="panelDevices">
        <div class="tools">
          <div class="row">
            <span class="pill" id="totalPill">total: -</span>
            <span class="pill" id="pagePill">offset: 0</span>
          </div>
          <div class="row">
            <button class="btn" id="prevBtn">上一页</button>
            <button class="btn" id="nextBtn">下一页</button>
            <button class="btn primary" id="addBtn">新增</button>
            <button class="btn" id="importBtn">导入</button>
          </div>
        </div>

        <div style="overflow:auto; border-radius:14px; border:1px solid rgba(255,255,255,.10)">
          <table>
            <thead>
              <tr>
                <th style="min-width:170px">device_id</th>
                <th style="min-width:160px">mac（记录）</th>
                <th style="min-width:90px">enabled</th>
                <th>note</th>
                <th style="min-width:180px">updated_at</th>
                <th style="min-width:160px">actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div id="toast" class="toast" style="display:none"></div>
      </div>

      <div class="card" id="panelOfficial" style="display:none">
        <div class="tools">
          <div class="row">
            <span class="pill" id="offTotalPill">total: -</span>
          </div>
          <div class="row">
            <button class="btn primary" id="offAddBtn">新增</button>
            <button class="btn" id="offRefreshBtn">刷新</button>
          </div>
        </div>

        <div style="overflow:auto; border-radius:14px; border:1px solid rgba(255,255,255,.10)">
          <table>
            <thead>
              <tr>
                <th style="min-width:140px">node_id</th>
                <th style="min-width:160px">name</th>
                <th style="min-width:220px">server(frps)</th>
                <th style="min-width:140px">token</th>
                <th style="min-width:220px">node_api</th>
                <th style="min-width:160px">domain_suffix</th>
                <th style="min-width:180px">updated_at</th>
                <th style="min-width:160px">actions</th>
              </tr>
            </thead>
            <tbody id="offTbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- modal -->
    <div id="modalRoot" style="display:none"></div>

    <script>
      const $ = (id) => document.getElementById(id);
      const state = { limit: 50, offset: 0, total: 0, rows: [] };
      const offState = { rows: [], total: 0 };

      function getKey(){ return localStorage.getItem('totoro_bridge_admin_key') || ''; }
      function setKey(v){ localStorage.setItem('totoro_bridge_admin_key', v || ''); }

      function toast(type, msg){
        const el = $('toast');
        el.className = 'toast ' + (type || '');
        el.textContent = msg;
        el.style.display = 'block';
        window.setTimeout(()=>{ el.style.display = 'none'; }, 1800);
      }

      async function api(path, opts){
        const key = $('adminKey').value.trim();
        const headers = Object.assign({ 'Content-Type':'application/json', 'X-Admin-Key': key }, (opts && opts.headers) || {});
        const res = await fetch(path, Object.assign({}, opts || {}, { headers }));
        const txt = await res.text();
        let json = null;
        try { json = JSON.parse(txt); } catch { /* ignore */ }
        if (!res.ok) throw new Error((json && (json.message || json.msg)) || ('HTTP ' + res.status));
        if (json && json.code !== 0) throw new Error(json.message || 'API error');
        return json ? json.data : null;
      }

      function render(){
        $('totalPill').textContent = 'total: ' + state.total;
        $('pagePill').textContent = 'offset: ' + state.offset + ' / limit: ' + state.limit;
        const tbody = $('tbody');
        tbody.innerHTML = '';
        for (const r of state.rows){
          const tr = document.createElement('tr');
          const enabled = !!r.enabled;
          tr.innerHTML = `
            <td><strong>${escapeHtml(r.device_id || '')}</strong></td>
            <td>${escapeHtml(r.mac || '')}</td>
            <td>${enabled ? '<span class="pill ok">enabled</span>' : '<span class="pill off">disabled</span>'}</td>
            <td style="color: rgba(229,231,235,.9)">${escapeHtml(r.note || '')}</td>
            <td style="color: rgba(229,231,235,.8)">${escapeHtml(r.updated_at || '')}</td>
            <td>
              <button class="btn" data-act="edit">编辑</button>
              <button class="btn danger" data-act="del">删除</button>
            </td>
          `;
          tr.querySelector('[data-act="edit"]').onclick = () => openUpsertModal(r);
          tr.querySelector('[data-act="del"]').onclick = () => confirmDelete(r.device_id);
          tbody.appendChild(tr);
        }
      }

      function escapeHtml(s){
        const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' };
        return String(s).replace(/[&<>"']/g, (c)=>map[c] || c);
      }

      async function load(){
        try{
          const data = await api(`/api/v1/admin/devices/whitelist?limit=${state.limit}&offset=${state.offset}`, { method:'GET' });
          state.rows = (data && data.devices) || [];
          state.total = (data && data.total) || 0;
          render();
        }catch(e){
          toast('err', e.message || String(e));
        }
      }

      async function loadOfficial(){
        try{
          const data = await api(`/api/v1/admin/official_nodes`, { method:'GET' });
          offState.rows = (data && data.nodes) || [];
          offState.total = offState.rows.length;
          $('offTotalPill').textContent = 'total: ' + offState.total;
          renderOfficial();
        }catch(e){
          toast('err', e.message || String(e));
        }
      }

      function renderOfficial(){
        const tbody = $('offTbody');
        tbody.innerHTML = '';
        for (const r of offState.rows){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${escapeHtml(r.node_id||'')}</strong></td>
            <td>${escapeHtml(r.name||'')}</td>
            <td>${escapeHtml(r.server||'')}</td>
            <td>${escapeHtml(r.token||'')}</td>
            <td>${escapeHtml(r.node_api||'')}</td>
            <td>${escapeHtml(r.domain_suffix||'')}</td>
            <td style="color: rgba(229,231,235,.8)">${escapeHtml(r.updated_at||'')}</td>
            <td>
              <button class="btn" data-act="edit">编辑</button>
              <button class="btn danger" data-act="del">删除</button>
            </td>
          `;
          tr.querySelector('[data-act="edit"]').onclick = () => openOfficialModal(r);
          tr.querySelector('[data-act="del"]').onclick = () => confirmDeleteOfficial(r.node_id);
          tbody.appendChild(tr);
        }
      }

      function modal(html){
        const root = $('modalRoot');
        root.style.display = 'block';
        root.innerHTML = `<div class="modalOverlay" id="modalOverlay">
          <div class="modal" id="modalPanel">${html}</div>
        </div>`;
        $('modalOverlay').onmousedown = () => closeModal();
        // 阻止点击弹窗内部时触发 overlay 关闭
        const panel = $('modalPanel');
        if (panel) panel.onmousedown = (e) => e.stopPropagation();
      }
      function closeModal(){
        const root = $('modalRoot');
        root.style.display = 'none';
        root.innerHTML = '';
      }

      function openUpsertModal(row){
        const isEdit = !!row;
        const r = row || { device_id:'', mac:'', enabled:true, note:'' };
        modal(`
          <div class="modalHeader">
            <div class="modalTitle">${isEdit ? '编辑白名单' : '新增白名单'}</div>
            <button class="btn ghost" id="closeBtn">×</button>
          </div>
          <div class="grid2">
            <div>
              <div class="hint" style="margin:6px 0 6px">device_id（必填）</div>
              <input id="m_device_id" placeholder="例如 DEV001" value="${escapeHtml(r.device_id||'')}" ${isEdit ? 'disabled' : ''} />
            </div>
            <div>
              <div class="hint" style="margin:6px 0 6px">enabled</div>
              <select id="m_enabled">
                <option value="true" ${r.enabled ? 'selected' : ''}>true</option>
                <option value="false" ${!r.enabled ? 'selected' : ''}>false</option>
              </select>
            </div>
          </div>
          <div class="grid2" style="margin-top:10px">
            <div>
              <div class="hint" style="margin:6px 0 6px">mac（记录，可空）</div>
              <input id="m_mac" placeholder="例如 AA:BB:CC:DD:EE:FF" value="${escapeHtml(r.mac||'')}" />
            </div>
            <div>
              <div class="hint" style="margin:6px 0 6px">note（可选）</div>
              <input id="m_note" placeholder="备注" value="${escapeHtml(r.note||'')}" />
            </div>
          </div>
          <div class="row" style="justify-content:flex-end; margin-top:14px">
            <button class="btn" id="cancelBtn">取消</button>
            <button class="btn primary" id="saveBtn">保存</button>
          </div>
        `);
        $('closeBtn').onclick = closeModal;
        $('cancelBtn').onclick = closeModal;
        $('saveBtn').onclick = async () => {
          const device_id = $('m_device_id').value.trim();
          const mac = $('m_mac').value.trim();
          const note = $('m_note').value.trim();
          const enabled = $('m_enabled').value === 'true';
          if (!device_id) { toast('warn', 'device_id 必填'); return; }
          try{
            await api('/api/v1/admin/devices/whitelist/upsert', { method:'POST', body: JSON.stringify({ device_id, mac, enabled, note }) });
            toast('ok','已保存');
            closeModal();
            load();
          }catch(e){
            toast('err', e.message || String(e));
          }
        };
      }

      function openOfficialModal(row){
        const isEdit = !!row;
        const r = row || { node_id:'', name:'', server:'', token:'', admin_addr:'', admin_user:'', admin_pwd:'', node_api:'', domain_suffix:'' };
        modal(`
          <div class="modalHeader">
            <div class="modalTitle">${isEdit ? '编辑官方内置节点' : '新增官方内置节点'}</div>
            <button class="btn ghost" id="closeBtn">×</button>
          </div>
          <div class="grid2">
            <div>
              <div class="hint" style="margin:6px 0 6px">node_id（必填）</div>
              <input id="m_node_id" placeholder="例如 official-1" value="${escapeHtml(r.node_id||'')}" ${isEdit ? 'disabled' : ''} />
            </div>
            <div>
              <div class="hint" style="margin:6px 0 6px">name</div>
              <input id="m_name" placeholder="展示名" value="${escapeHtml(r.name||'')}" />
            </div>
          </div>
          <div class="grid2" style="margin-top:10px">
            <div>
              <div class="hint" style="margin:6px 0 6px">server(frps)（必填）</div>
              <input id="m_server" placeholder="例如 117.xx.xx.xx:7000" value="${escapeHtml(r.server||'')}" />
            </div>
            <div>
              <div class="hint" style="margin:6px 0 6px">token（可选）</div>
              <input id="m_token" placeholder="frps token" value="${escapeHtml(r.token||'')}" />
            </div>
          </div>
          <div class="grid2" style="margin-top:10px">
            <div>
              <div class="hint" style="margin:6px 0 6px">node_api（可选）</div>
              <input id="m_node_api" placeholder="例如 http://x.x.x.x:18080" value="${escapeHtml(r.node_api||'')}" />
            </div>
            <div>
              <div class="hint" style="margin:6px 0 6px">domain_suffix（可选）</div>
              <input id="m_domain" placeholder="例如 frpc.example.com" value="${escapeHtml(r.domain_suffix||'')}" />
            </div>
          </div>
          <div class="row" style="justify-content:flex-end; margin-top:14px">
            <button class="btn" id="cancelBtn">取消</button>
            <button class="btn primary" id="saveBtn">保存</button>
          </div>
        `);
        $('closeBtn').onclick = closeModal;
        $('cancelBtn').onclick = closeModal;
        $('saveBtn').onclick = async () => {
          const node_id = $('m_node_id').value.trim();
          const name = $('m_name').value.trim();
          const server = $('m_server').value.trim();
          const token = $('m_token').value.trim();
          const node_api = $('m_node_api').value.trim();
          const domain_suffix = $('m_domain').value.trim();
          if (!node_id || !server) { toast('warn','node_id/server 必填'); return; }
          try{
            await api('/api/v1/admin/official_nodes/upsert', { method:'POST', body: JSON.stringify({ node_id, name, server, token, node_api, domain_suffix }) });
            toast('ok','已保存');
            closeModal();
            loadOfficial();
          }catch(e){
            toast('err', e.message || String(e));
          }
        };
      }

      function confirmDeleteOfficial(nodeID){
        modal(`
          <div class="modalHeader">
            <div class="modalTitle">确认删除官方节点</div>
            <button class="btn ghost" id="closeBtn">×</button>
          </div>
          <div class="hint">将删除：<code>${escapeHtml(nodeID)}</code></div>
          <div class="row" style="justify-content:flex-end; margin-top:14px">
            <button class="btn" id="cancelBtn">取消</button>
            <button class="btn danger" id="delBtn">删除</button>
          </div>
        `);
        $('closeBtn').onclick = closeModal;
        $('cancelBtn').onclick = closeModal;
        $('delBtn').onclick = async () => {
          try{
            await api('/api/v1/admin/official_nodes/delete', { method:'POST', body: JSON.stringify({ node_id: nodeID }) });
            toast('ok','已删除');
            closeModal();
            loadOfficial();
          }catch(e){
            toast('err', e.message || String(e));
          }
        };
      }

      function openImportModal(){
        modal(`
          <div class="modalHeader">
            <div class="modalTitle">批量导入（CSV/文本）</div>
            <button class="btn ghost" id="closeBtn">×</button>
          </div>
          <div class="hint" style="margin:4px 0 10px">
            每行：<code>device_id[,enabled][,note]</code>，enabled 支持 1/0/true/false/on/off。
          </div>
          <textarea id="m_csv" placeholder="DEV001,true,测试设备\nDEV002,0,停用"></textarea>
          <div class="row" style="justify-content:flex-end; margin-top:12px">
            <button class="btn" id="cancelBtn">取消</button>
            <button class="btn primary" id="importDoBtn">导入</button>
          </div>
        `);
        $('closeBtn').onclick = closeModal;
        $('cancelBtn').onclick = closeModal;
        $('importDoBtn').onclick = async () => {
          const csv = $('m_csv').value;
          if (!csv.trim()) { toast('warn','内容为空'); return; }
          try{
            const data = await api('/api/v1/admin/devices/whitelist/import', { method:'POST', body: JSON.stringify({ csv }) });
            toast('ok', `导入完成 imported=${data.imported||0} skipped=${data.skipped||0}`);
            closeModal();
            load();
          }catch(e){
            toast('err', e.message || String(e));
          }
        }
      }

      function confirmDelete(deviceID){
        modal(`
          <div class="modalHeader">
            <div class="modalTitle">确认删除</div>
            <button class="btn ghost" id="closeBtn">×</button>
          </div>
          <div class="hint">将从白名单删除：<code>${escapeHtml(deviceID)}</code></div>
          <div class="row" style="justify-content:flex-end; margin-top:14px">
            <button class="btn" id="cancelBtn">取消</button>
            <button class="btn danger" id="delBtn">删除</button>
          </div>
        `);
        $('closeBtn').onclick = closeModal;
        $('cancelBtn').onclick = closeModal;
        $('delBtn').onclick = async () => {
          try{
            await api('/api/v1/admin/devices/whitelist/delete', { method:'POST', body: JSON.stringify({ device_id: deviceID }) });
            toast('ok','已删除');
            closeModal();
            load();
          }catch(e){
            toast('err', e.message || String(e));
          }
        };
      }

      // init
      $('adminKey').value = getKey();
      $('saveKeyBtn').onclick = () => { setKey($('adminKey').value.trim()); toast('ok','已保存 AdminKey'); };
      $('refreshBtn').onclick = () => load();
      $('prevBtn').onclick = () => { state.offset = Math.max(0, state.offset - state.limit); load(); };
      $('nextBtn').onclick = () => { if (state.offset + state.limit < state.total) state.offset += state.limit; load(); };
      $('addBtn').onclick = () => openUpsertModal(null);
      $('importBtn').onclick = () => openImportModal();

      function setTab(tab){
        const devBtn = $('tabDevices');
        const offBtn = $('tabOfficial');
        const pDev = $('panelDevices');
        const pOff = $('panelOfficial');
        if (tab === 'official'){
          devBtn.classList.remove('primary'); offBtn.classList.add('primary');
          pDev.style.display = 'none'; pOff.style.display = 'block';
          loadOfficial();
        } else {
          offBtn.classList.remove('primary'); devBtn.classList.add('primary');
          pOff.style.display = 'none'; pDev.style.display = 'block';
          load();
        }
      }
      $('tabDevices').onclick = () => setTab('devices');
      $('tabOfficial').onclick = () => setTab('official');
      $('offAddBtn').onclick = () => openOfficialModal(null);
      $('offRefreshBtn').onclick = () => loadOfficial();

      load();
    </script>
  </body>
</html>


