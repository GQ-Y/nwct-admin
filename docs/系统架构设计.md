# 内网穿透盒子系统架构设计文档

## 1. 整体架构

### 1.1 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     用户/管理员                               │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       │ HTTP/WebSocket
                       │
┌──────────────────────▼──────────────────────────────────────┐
│              内网穿透盒子设备 (客户端)                         │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              Web控制面板 (React)                       │  │
│  │  - 设备初始化  - 网络工具箱  - 系统管理  - MQTT日志    │  │
│  └───────────────────┬──────────────────────────────────┘  │
│                      │ HTTP API                            │
│  ┌───────────────────▼──────────────────────────────────┐  │
│  │              核心服务层 (Go)                           │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │  │
│  │  │ 网络管理  │  │ 设备扫描  │  │ 网络工具  │          │  │
│  │  └──────────┘  └──────────┘  └──────────┘          │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │  │
│  │  │ NPS客户端 │  │ MQTT客户端│  │ HTTP API │          │  │
│  │  └──────────┘  └──────────┘  └──────────┘          │  │
│  └───────────────────┬──────────────────────────────────┘  │
│                      │                                      │
│  ┌───────────────────▼──────────────────────────────────┐  │
│  │              配置存储层                                │  │
│  │  - 配置文件  - 设备数据库  - 日志文件                  │  │
│  └──────────────────────────────────────────────────────┘  │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        │ NPS协议      │ MQTT协议     │ HTTP/HTTPS
        │              │              │
┌───────▼──────┐  ┌───▼──────────┐  ┌▼──────────────┐
│  NPS服务端    │  │  MQTT服务器   │  │  远程管理端    │
│  (公网服务器)  │  │  (可选)      │  │  (可选)       │
└──────────────┘  └──────────────┘  └───────────────┘
```

### 1.2 架构层次

#### 1.2.1 前端层
- **技术栈**: React + TypeScript + Ant Design
- **功能**: Web控制面板UI
- **通信**: HTTP RESTful API + WebSocket

#### 1.2.2 应用服务层
- **技术栈**: Go语言
- **模块**:
  - HTTP API服务
  - WebSocket服务
  - 网络管理模块
  - 设备扫描模块
  - 网络工具箱模块
  - NPS客户端模块
  - MQTT客户端模块
  - 配置管理模块

#### 1.2.3 数据存储层
- **配置文件**: JSON/YAML格式
- **设备数据库**: SQLite（轻量级）
- **日志文件**: 文本文件

#### 1.2.4 网络通信层
- **NPS协议**: 内网穿透通信
- **MQTT协议**: 设备状态通知和远程控制
- **HTTP/HTTPS**: Web管理界面
- **ARP/ICMP**: 局域网设备发现

## 2. 核心模块设计

### 2.1 网络管理模块

#### 2.1.1 功能职责
- 管理网络接口（有线网口、WiFi）
- 网络连接状态监控
- 自动切换网络连接
- 网络配置管理

#### 2.1.2 接口设计
```go
type NetworkManager interface {
    // 获取网络接口列表
    GetInterfaces() ([]NetworkInterface, error)
    
    // 配置WiFi连接
    ConfigureWiFi(ssid, password string) error
    
    // 获取当前网络状态
    GetNetworkStatus() (NetworkStatus, error)
    
    // 测试网络连接
    TestConnection(target string) error
}
```

### 2.2 设备扫描模块

#### 2.2.1 功能职责
- 扫描局域网设备
- 采集设备信息（IP、MAC、名称）
- 设备识别和分类
- 设备信息存储

#### 2.2.2 扫描策略
1. **ARP扫描**: 快速发现活跃设备
2. **ICMP Ping**: 验证设备可达性
3. **端口扫描**: 识别开放服务
4. **协议探测**: 
   - NetBIOS查询设备名
   - mDNS/Bonjour查询
   - SNMP查询（如果支持）
   - HTTP请求获取设备信息

#### 2.2.3 设备识别引擎
- **MAC地址OUI识别**: 基于IEEE OUI数据库识别厂商
- **端口指纹识别**: 基于开放端口识别设备类型
- **HTTP响应识别**: 基于HTTP响应头识别设备
- **自定义规则**: 支持用户自定义识别规则

#### 2.2.4 接口设计
```go
type DeviceScanner interface {
    // 启动扫描
    StartScan() error
    
    // 停止扫描
    StopScan() error
    
    // 获取扫描结果
    GetDevices() ([]Device, error)
    
    // 获取设备详情
    GetDeviceDetail(ip string) (DeviceDetail, error)
}
```

### 2.3 网络工具箱模块

#### 2.3.1 网络探针
- ARP扫描
- ICMP Ping
- Traceroute
- DNS查询

#### 2.3.2 网速测试
- 带宽测试（上传/下载）
- 延迟测试
- 测试结果统计

#### 2.3.3 端口测试
- 端口扫描
- 服务识别
- 端口连通性测试

#### 2.3.4 接口设计
```go
type NetworkToolkit interface {
    // ARP扫描
    ARPScan(subnet string) ([]Device, error)
    
    // Ping测试
    Ping(target string, count int) (PingResult, error)
    
    // Traceroute
    Traceroute(target string) ([]Hop, error)
    
    // 带宽测试
    SpeedTest(server string) (SpeedResult, error)
    
    // 端口扫描
    PortScan(target string, ports []int) ([]PortInfo, error)
}
```

### 2.4 NPS客户端模块

#### 2.4.1 功能职责
- 连接NPS服务端
- 建立内网穿透隧道
- 管理穿透连接
- 连接状态监控

#### 2.4.2 接口设计
```go
type NPSClient interface {
    // 连接到NPS服务端
    Connect(config NPSServerConfig) error
    
    // 断开连接
    Disconnect() error
    
    // 获取连接状态
    GetStatus() (NPSStatus, error)
    
    // 添加穿透隧道
    AddTunnel(tunnel TunnelConfig) error
}
```

### 2.5 MQTT客户端模块

#### 2.5.1 功能职责
- 连接MQTT服务器
- 发布设备状态消息
- 订阅远程控制命令
- 消息日志记录

#### 2.5.2 主题设计
- **设备状态**: `nwct/{device_id}/status` (在线/离线)
- **设备心跳**: `nwct/{device_id}/heartbeat`
- **远程命令**: `nwct/{device_id}/command`
- **命令响应**: `nwct/{device_id}/response`
- **设备数据**: `nwct/{device_id}/data` (扫描结果、测试结果等)

#### 2.5.3 消息格式
```json
{
  "timestamp": "2024-01-01T12:00:00Z",
  "device_id": "device_001",
  "type": "status|command|response|data",
  "payload": {}
}
```

#### 2.5.4 接口设计
```go
type MQTTClient interface {
    // 连接到MQTT服务器
    Connect(config MQTTConfig) error
    
    // 断开连接
    Disconnect() error
    
    // 发布消息
    Publish(topic string, message interface{}) error
    
    // 订阅主题
    Subscribe(topic string, handler MessageHandler) error
    
    // 获取连接状态
    GetStatus() (MQTTStatus, error)
}
```

### 2.6 HTTP API服务模块

#### 2.6.1 API路由设计
```
/api/v1/
  ├── /auth              # 认证相关
  │   ├── POST /login
  │   ├── POST /logout
  │   └── POST /change-password
  ├── /system            # 系统管理
  │   ├── GET /info
  │   ├── POST /restart
  │   └── GET /logs
  ├── /network           # 网络管理
  │   ├── GET /interfaces
  │   ├── POST /wifi/connect
  │   └── GET /status
  ├── /devices           # 设备扫描
  │   ├── GET /list
  │   ├── GET /:ip/detail
  │   ├── POST /scan/start
  │   └── POST /scan/stop
  ├── /tools             # 网络工具箱
  │   ├── POST /ping
  │   ├── POST /traceroute
  │   ├── POST /speedtest
  │   └── POST /portscan
  ├── /nps               # NPS管理
  │   ├── GET /status
  │   ├── POST /connect
  │   └── GET /tunnels
  ├── /mqtt              # MQTT管理
  │   ├── GET /status
  │   ├── POST /connect
  │   └── GET /logs
  └── /config            # 配置管理
      ├── GET /current
      ├── POST /update
      └── POST /init
```

#### 2.6.2 WebSocket设计
- **连接路径**: `/ws`
- **消息类型**:
  - 实时日志推送
  - 设备状态更新
  - 扫描进度更新
  - 测试结果推送

## 3. 数据模型设计

### 3.1 设备信息模型
```go
type Device struct {
    IP          string    `json:"ip"`
    MAC         string    `json:"mac"`
    Name        string    `json:"name"`
    Vendor      string    `json:"vendor"`
    Type        string    `json:"type"`
    OS          string    `json:"os"`
    Status      string    `json:"status"`      // online/offline
    OpenPorts   []int     `json:"open_ports"`
    LastSeen    time.Time `json:"last_seen"`
    FirstSeen   time.Time `json:"first_seen"`
}
```

### 3.2 配置模型
```go
type Config struct {
    Device      DeviceConfig      `json:"device"`
    Network     NetworkConfig     `json:"network"`
    NPSServer   NPSServerConfig  `json:"nps_server"`
    MQTT        MQTTConfig        `json:"mqtt"`
    Scanner     ScannerConfig     `json:"scanner"`
}
```

### 3.3 日志模型
```go
type LogEntry struct {
    Timestamp   time.Time `json:"timestamp"`
    Level       string    `json:"level"`
    Module      string    `json:"module"`
    Message     string    `json:"message"`
    Data        interface{} `json:"data,omitempty"`
}
```

## 4. 工作流程设计

### 4.1 设备启动流程
```
1. 系统启动
2. 加载配置文件
3. 初始化网络接口
4. 连接网络（有线/WiFi）
5. 连接MQTT服务器
6. 发送上线通知
7. 连接NPS服务端
8. 启动HTTP API服务
9. 启动WebSocket服务
10. 自动启动设备扫描
```

### 4.2 设备扫描流程
```
1. 获取本地网络接口信息
2. 计算局域网网段
3. ARP扫描发现设备
4. 对每个设备：
   a. ICMP Ping验证
   b. 获取MAC地址
   c. 查询设备名称（NetBIOS/mDNS）
   d. 端口扫描
   e. 设备识别
   f. 存储设备信息
5. 更新设备列表
6. 通过MQTT发布扫描结果
```

### 4.3 远程控制流程
```
1. 管理端通过MQTT发送命令
2. 设备接收命令
3. 验证命令合法性
4. 执行命令
5. 返回执行结果
6. 记录操作日志
```

## 5. 安全设计

### 5.1 认证授权
- Web界面密码认证
- JWT Token机制
- MQTT用户名密码认证
- API接口Token验证

### 5.2 数据安全
- 密码加密存储（bcrypt）
- 敏感配置加密
- HTTPS支持（可选）
- MQTT TLS加密（可选）

### 5.3 访问控制
- IP白名单（可选）
- 请求频率限制
- 命令执行权限验证

## 6. 性能优化

### 6.1 扫描优化
- 并发扫描
- 智能扫描间隔
- 增量更新设备列表
- 缓存设备信息

### 6.2 资源管理
- 连接池管理
- 内存使用优化
- 日志轮转
- 数据库优化

## 7. 容错设计

### 7.1 网络容错
- 自动重连机制
- 连接超时处理
- 网络切换处理

### 7.2 服务容错
- 服务异常恢复
- 配置验证
- 数据备份

### 7.3 日志和监控
- 详细日志记录
- 错误告警
- 性能监控

