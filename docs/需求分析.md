# 内网穿透盒子需求分析文档

## 1. 项目概述

### 1.1 项目背景
设计一款内网穿透盒子设备，用于实现内网设备的远程访问和管理。设备采用单片机架构，支持多种网络连接方式，集成NPS客户端实现内网穿透功能。

### 1.2 核心目标
- 提供稳定可靠的内网穿透服务
- 支持局域网设备自动发现和识别
- 提供网络诊断和测试工具
- 实现远程管理和控制能力
- 提供友好的Web控制界面

## 2. **硬件需求**

### 2.1 硬件规格
- **设备类型**: 单片机设备
- **网络接口**: 
  - 有线网口（RJ45）
  - WiFi无线连接（2.4G/5G双频）
- **供电方式**: USB直接供电（5V）
- **存储**: 支持配置持久化存储
- **指示灯**: 状态指示（电源、网络、运行状态）

### 2.2 硬件约束
- 资源受限环境（内存、CPU）
- 低功耗设计
- 长时间稳定运行

## 3. 系统架构需求

### 3.1 客户端-服务端架构
- **客户端**: 运行在盒子设备上的NPS客户端
- **服务端**: 独立的NPS服务端（可部署在云端或公网服务器）

### 3.2 通信协议
- **内网穿透**: NPS协议
- **设备通信**: MQTT协议
- **Web管理**: HTTP/WebSocket
- **设备发现**: ARP扫描、ICMP探测

## 4. 功能需求

### 4.1 网络连接管理
- **自动联网**: 
  - 优先使用有线网口连接
  - 有线断开时自动切换到WiFi
  - 支持WiFi热点配置和连接
- **网络状态监控**: 
  - 实时监控网络连接状态
  - 网络断开自动重连
  - 连接质量评估

### 4.2 局域网设备扫描
- **自动扫描**: 
  - 设备联网后自动启动扫描
  - 定时扫描（可配置间隔）
  - 支持手动触发扫描
- **设备信息采集**:
  - IP地址
  - MAC地址
  - 设备名称（通过NetBIOS、mDNS等协议获取）
  - 设备类型识别（基于MAC地址OUI、端口扫描、协议特征）
  - 操作系统识别
  - 开放端口列表
- **设备识别规则**:
  - 基于MAC地址OUI识别厂商
  - 基于开放端口识别服务类型
  - 基于HTTP响应头识别设备类型
  - 基于SNMP信息识别网络设备
  - 自定义设备识别规则

### 4.3 网络工具箱功能

#### 4.3.1 网络探针
- **ARP扫描**: 快速发现局域网内活跃设备
- **ICMP Ping**: 检测设备可达性
- **路由追踪**: Traceroute功能
- **DNS查询**: 正向/反向DNS解析
- **网络拓扑**: 构建局域网拓扑图

#### 4.3.2 网速测试
- **带宽测试**: 
  - 上传速度测试
  - 下载速度测试
  - 延迟测试（RTT）
- **测试目标**: 
  - 测试到公网服务器的速度
  - 测试局域网内设备间速度
  - 测试到NPS服务端的速度

#### 4.3.3 端口测试
- **端口扫描**: 
  - 单端口扫描
  - 端口范围扫描
  - 常用端口扫描
- **服务检测**: 
  - 识别端口对应服务
  - 服务版本识别
  - 服务状态检测
- **端口连通性**: 
  - TCP连接测试
  - UDP端口测试

### 4.4 MQTT通信功能

#### 4.4.1 在线/离线通知
- **上线通知**: 设备启动并连接MQTT后发送上线消息
- **离线通知**: 设备正常关闭时发送离线消息（Last Will）
- **心跳机制**: 定期发送心跳消息保持连接
- **重连机制**: 连接断开后自动重连

#### 4.4.2 远程命令
- **软重启命令**: 通过MQTT接收重启指令，执行设备软重启
- **配置更新**: 通过MQTT接收配置更新指令
- **功能触发**: 通过MQTT触发扫描、测试等功能
- **命令确认**: 命令执行后返回执行结果

#### 4.4.3 消息日志
- **消息记录**: 记录所有MQTT消息（发布/订阅）
- **日志存储**: 本地存储MQTT消息日志
- **日志查询**: 支持按时间、主题、类型查询日志

### 4.5 Web控制面板功能

#### 4.5.1 设备初始化
- **首次配置向导**: 
  - WiFi配置
  - 网络参数配置（静态IP/DHCP）
  - NPS服务端配置
  - MQTT服务器配置
  - 管理员密码设置
- **配置验证**: 配置后验证连接有效性
- **配置导入/导出**: 支持配置文件导入导出

#### 4.5.2 网络工具箱界面
- **设备列表**: 
  - 显示扫描到的设备
  - 设备详细信息展示
  - 设备状态实时更新
- **工具面板**: 
  - 网络探针工具界面
  - 网速测试工具界面
  - 端口测试工具界面
- **结果展示**: 
  - 测试结果可视化
  - 历史记录查看
  - 结果导出功能

#### 4.5.3 系统管理
- **密码修改**: 
  - 修改Web登录密码
  - 修改MQTT连接密码
- **设备重启**: 
  - 软重启
  - 硬重启（如果支持）
- **系统信息**: 
  - 设备运行状态
  - 网络连接状态
  - 资源使用情况
  - 系统日志查看

#### 4.5.4 MQTT消息日志
- **实时日志**: 实时显示MQTT消息
- **日志过滤**: 
  - 按主题过滤
  - 按消息类型过滤
  - 按时间范围过滤
- **日志详情**: 查看消息详细内容
- **日志导出**: 导出日志为文件

## 5. 非功能需求

### 5.1 性能需求
- 设备扫描响应时间 < 30秒（100设备以内）
- Web界面响应时间 < 2秒
- MQTT消息延迟 < 1秒
- 系统启动时间 < 60秒

### 5.2 可靠性需求
- 7x24小时稳定运行
- 网络断开自动重连
- 异常自动恢复
- 配置数据持久化

### 5.3 安全性需求
- Web界面HTTPS访问（可选）
- 密码加密存储
- MQTT TLS加密连接（可选）
- 防止未授权访问

### 5.4 易用性需求
- 友好的Web界面
- 清晰的配置向导
- 详细的错误提示
- 操作日志记录

## 6. 技术约束

### 6.1 开发语言
- 后端: Go语言
- 前端: React + TypeScript

### 6.2 依赖组件
- NPS客户端库
- MQTT客户端库
- Web框架（Gin）
- 网络扫描库

### 6.3 资源限制
- 内存占用 < 128MB
- CPU占用 < 50%（空闲时）
- 存储占用 < 500MB

## 7. 部署需求

### 7.1 设备端部署
- 固件烧录
- 配置文件初始化
- 自动启动服务

### 7.2 服务端部署
- NPS服务端部署（独立服务器）
- MQTT服务器部署（可选，可使用公共MQTT服务）

## 8. 扩展需求（未来）

### 8.1 功能扩展
- 支持多NPS服务端连接
- 支持设备分组管理
- 支持自定义设备识别规则
- 支持网络流量监控
- 支持VPN功能

### 8.2 集成扩展
- 支持Home Assistant集成
- 支持第三方IoT平台
- 支持Webhook通知
- 支持API接口开放

