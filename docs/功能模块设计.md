# 功能模块详细设计文档

## 1. 设备初始化模块

### 1.1 功能概述
设备首次启动或恢复出厂设置后，引导用户完成基础配置。

### 1.2 初始化流程
1. **检测初始化状态**
   - 检查配置文件是否存在
   - 检查是否已完成初始化

2. **网络配置**
   - 选择网络连接方式（有线/WiFi）
   - WiFi配置：
     - 扫描可用WiFi热点
     - 输入SSID和密码
     - 测试连接
   - 网络参数配置：
     - DHCP自动获取
     - 静态IP配置（IP、子网掩码、网关、DNS）

3. **NPS服务端配置**
   - 服务端地址（IP/域名）
   - 服务端端口
   - 验证密钥（VKey）
   - 客户端ID
   - 连接测试

4. **MQTT服务器配置**
   - 服务器地址
   - 服务器端口
   - 用户名和密码
   - 客户端ID
   - 连接测试

5. **管理员密码设置**
   - 设置Web登录密码
   - 密码强度验证
   - 确认密码

6. **配置保存和验证**
   - 保存所有配置
   - 验证各项服务连接
   - 完成初始化

### 1.3 前端界面设计
- **步骤式向导界面**
  - 步骤1: 欢迎页面
  - 步骤2: 网络配置
  - 步骤3: NPS配置
  - 步骤4: MQTT配置
  - 步骤5: 密码设置
  - 步骤6: 完成确认

- **功能特性**
  - 实时配置验证
  - 错误提示和解决建议
  - 配置进度显示
  - 支持返回上一步修改

### 1.4 API接口
```
POST /api/v1/config/init
  - 请求体: 初始化配置
  - 响应: 初始化结果

GET /api/v1/config/init/status
  - 响应: 初始化状态

POST /api/v1/config/init/test-network
  - 请求体: 网络配置
  - 响应: 测试结果

POST /api/v1/config/init/test-nps
  - 请求体: NPS配置
  - 响应: 测试结果

POST /api/v1/config/init/test-mqtt
  - 请求体: MQTT配置
  - 响应: 测试结果
```

## 2. 网络工具箱模块

### 2.1 设备扫描功能

#### 2.1.1 扫描算法
1. **ARP扫描**
   - 发送ARP请求到网段内所有IP
   - 收集ARP响应
   - 提取MAC地址和IP映射

2. **设备信息采集**
   - IP地址（从ARP响应获取）
   - MAC地址（从ARP响应获取）
   - 设备名称：
     - NetBIOS名称查询
     - mDNS/Bonjour查询
     - DNS反向查询
   - 设备识别：
     - MAC地址OUI查询
     - 端口扫描识别
     - HTTP响应分析

3. **设备分类**
   - 网络设备（路由器、交换机）
   - 计算机设备（PC、服务器）
   - 移动设备（手机、平板）
   - IoT设备（智能家居）
   - 其他设备

#### 2.1.2 扫描配置
- 扫描网段（自动检测或手动指定）
- 扫描间隔（定时扫描）
- 扫描超时时间
- 并发扫描数量

#### 2.1.3 设备列表展示
- **列表视图**
  - 设备图标（基于设备类型）
  - IP地址
  - MAC地址
  - 设备名称
  - 设备类型
  - 状态（在线/离线）
  - 最后发现时间

- **详情视图**
  - 基本信息
  - 开放端口列表
  - 设备识别信息
  - 历史记录

### 2.2 网络探针功能

#### 2.2.1 ARP扫描
- **功能**: 快速发现局域网内活跃设备
- **参数**:
  - 目标网段
  - 扫描超时
- **结果**: 设备IP和MAC地址列表

#### 2.2.2 Ping测试
- **功能**: 检测设备可达性和延迟
- **参数**:
  - 目标IP/域名
  - Ping次数
  - 超时时间
- **结果**:
  - 丢包率
  - 平均延迟
  - 最小/最大延迟
  - 延迟统计图

#### 2.2.3 Traceroute
- **功能**: 追踪数据包路由路径
- **参数**:
  - 目标IP/域名
  - 最大跳数
- **结果**: 路由跳转列表（IP、延迟）

#### 2.2.4 DNS查询
- **功能**: DNS正向/反向解析
- **参数**:
  - 查询类型（A、AAAA、PTR、MX等）
  - 查询目标
- **结果**: DNS记录信息

### 2.3 网速测试功能

#### 2.3.1 测试原理
- **上传测试**: 向测试服务器上传数据，计算上传速度
- **下载测试**: 从测试服务器下载数据，计算下载速度
- **延迟测试**: 测量RTT（往返时延）

#### 2.3.2 测试服务器
- 默认测试服务器列表
- 支持自定义测试服务器
- 自动选择最优服务器

#### 2.3.3 测试结果
- 上传速度（Mbps）
- 下载速度（Mbps）
- 延迟（ms）
- 测试时间
- 结果可视化（图表）

### 2.4 端口测试功能

#### 2.4.1 端口扫描
- **扫描方式**:
  - TCP全连接扫描
  - TCP SYN扫描
  - UDP端口扫描

- **扫描范围**:
  - 单端口扫描
  - 端口范围扫描
  - 常用端口扫描（预定义列表）

#### 2.4.2 服务识别
- **识别方法**:
  - 端口号识别（常见端口）
  - Banner抓取（TCP连接后读取响应）
  - 协议特征识别

- **识别结果**:
  - 服务名称
  - 服务版本（如果可识别）
  - 服务状态

#### 2.4.3 端口连通性测试
- **功能**: 测试指定端口是否开放
- **参数**:
  - 目标IP
  - 端口号
  - 协议（TCP/UDP）
- **结果**: 端口状态（开放/关闭/过滤）

### 2.5 前端界面设计

#### 2.5.1 主界面布局
- **顶部导航**: 设备列表、网络探针、网速测试、端口测试
- **侧边栏**: 工具快捷入口
- **主内容区**: 当前工具界面

#### 2.5.2 设备列表界面
- 设备卡片/列表展示
- 搜索和过滤功能
- 设备详情弹窗
- 刷新和扫描控制

#### 2.5.3 工具界面
- 参数输入表单
- 测试执行按钮
- 实时结果显示
- 历史记录查看
- 结果导出功能

## 3. 系统管理模块

### 3.1 密码修改功能

#### 3.1.1 修改流程
1. 验证当前密码
2. 输入新密码
3. 确认新密码
4. 密码强度验证
5. 保存新密码
6. 更新会话（如需）

#### 3.1.2 密码策略
- 最小长度要求（8位）
- 复杂度要求（字母+数字+特殊字符）
- 不能与旧密码相同

### 3.2 设备重启功能

#### 3.2.1 重启方式
- **软重启**: 通过系统命令重启
- **硬重启**: 如果硬件支持，通过GPIO控制

#### 3.2.2 重启流程
1. 保存当前配置
2. 停止所有服务
3. 执行重启命令
4. 发送重启通知（MQTT）

### 3.3 系统信息展示

#### 3.3.1 设备信息
- 设备ID
- 固件版本
- 运行时间
- 启动时间

#### 3.3.2 网络状态
- 当前网络接口
- IP地址
- 网络连接状态
- 网络流量统计

#### 3.3.3 资源使用
- CPU使用率
- 内存使用率
- 存储使用情况
- 网络连接数

#### 3.3.4 服务状态
- NPS连接状态
- MQTT连接状态
- HTTP服务状态
- 各模块运行状态

### 3.4 系统日志

#### 3.4.1 日志类型
- 系统日志
- 网络日志
- 错误日志
- 操作日志

#### 3.4.2 日志查看
- 实时日志流
- 日志搜索
- 日志过滤
- 日志导出

## 4. MQTT消息日志模块

### 4.1 日志记录

#### 4.1.1 记录内容
- 消息时间戳
- 消息主题
- 消息方向（发布/订阅）
- 消息内容
- 消息QoS级别
- 消息状态（成功/失败）

#### 4.1.2 日志存储
- 本地文件存储
- 数据库存储（可选）
- 日志轮转（按大小或时间）

### 4.2 日志查看界面

#### 4.2.1 实时日志
- WebSocket实时推送
- 自动滚动显示
- 消息高亮显示

#### 4.2.2 历史日志
- 日志列表展示
- 分页加载
- 时间范围选择

#### 4.2.3 日志过滤
- 按主题过滤
- 按消息类型过滤
- 按时间范围过滤
- 按关键词搜索

#### 4.2.4 日志详情
- 消息完整内容
- JSON格式化显示
- 消息元数据

### 4.3 日志导出
- 导出为文本文件
- 导出为JSON文件
- 导出为CSV文件（表格数据）

## 5. 数据持久化设计

### 5.1 配置文件
- **位置**: `/etc/nwct/config.json`
- **内容**: 系统配置、网络配置、服务配置
- **格式**: JSON
- **加密**: 敏感信息加密存储

### 5.2 设备数据库
- **数据库**: SQLite
- **位置**: `/var/nwct/devices.db`
- **表结构**:
  - devices: 设备基本信息
  - device_ports: 设备端口信息
  - device_history: 设备历史记录

### 5.3 日志文件
- **系统日志**: `/var/log/nwct/system.log`
- **MQTT日志**: `/var/log/nwct/mqtt.log`
- **网络日志**: `/var/log/nwct/network.log`
- **日志轮转**: 按大小（10MB）或时间（每天）

## 6. 错误处理设计

### 6.1 错误分类
- **网络错误**: 连接失败、超时等
- **配置错误**: 无效配置、缺失配置等
- **服务错误**: 服务启动失败、服务异常等
- **系统错误**: 资源不足、权限问题等

### 6.2 错误处理策略
- **自动重试**: 网络连接错误自动重试
- **降级处理**: 服务不可用时的降级方案
- **错误通知**: 通过MQTT发送错误通知
- **日志记录**: 详细记录错误信息

### 6.3 用户提示
- 友好的错误提示信息
- 错误解决建议
- 错误代码和详细信息

