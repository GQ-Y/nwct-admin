# Totoro 服务端开发路线图（无注册版）

## 0. 路线图原则

- **先把共享节点跑通**：邀请码 -> 票据 -> frps 回调鉴权 -> 代理注册鉴权。
- **先做硬约束再做体验**：MVP 先保证“能控、能限、能审计”，Beta 再做域名/证书自动化与监控面板。
- **控制面稳定优先**：策略与校验统一在控制面，frps 侧保持最小改造面。

---

## 1. 阶段一：MVP（8-12 周）

### 1.1 交付目标

- 客户端无需注册：输入邀请码即可连接私有节点；公开节点可直接选择。
- 节点可公开/私有；私有节点通过邀请码分享。
- frps 数据面具备最小鉴权与限额能力（端口池、并发、proxy 数量）。
- 控制面具备最小审计与统计（会话/代理事件）。

### 1.2 功能清单

#### A) 控制面（totoro-control-plane）

- 公开节点列表：`GET /api/v1/public/nodes`
- 邀请码解析：`POST /api/v1/invites/resolve`
- 节点心跳：`POST /api/v1/nodes/heartbeat`（node_key 鉴权）
- 节点生成邀请码：`POST /api/v1/nodes/invites`
- frps 鉴权回调：
  - `POST /api/v1/frps/auth/handshake`
  - `POST /api/v1/frps/auth/proxy`
- 事件审计落库：invite/session/proxy 最小事件集

#### B) 数据面（totoro-frps）

- 接入握手鉴权回调（handshake）
- 接入 proxy 注册鉴权回调（proxy）
- 配额（MVP）：
  - `max_conns`（invite 维度）
  - `max_proxies`（invite 维度）
  - 端口池校验/分配（tcp/udp）
- 日志增强字段：`node_id/invite_id/proxy_name/reason`

#### C) 节点侧（totoro-node-agent）

- 心跳与基础指标上报（CPU/内存/带宽、连接/代理计数）
- 版本信息上报（frps/node-agent）

#### D) 客户端对接（已有客户端上做最小增量）

- `client-web`：新增“官方节点列表”和“邀请码连接”入口
- `client-nps`：新增拉取节点列表/邀请码解析 API 调用（复用现有 `/api/v1/frp/connect`）\n

### 1.3 验收标准（MVP）

- 公开节点：客户端能拉取列表并成功连接
- 私有节点：邀请码解析成功后，客户端能在票据有效期内稳定连接
- 限额：\n
  - 超出 `max_conns` 连接被拒绝（返回明确 reason）\n
  - 超出 `max_proxies` 注册被拒绝\n
  - 端口不在池内注册被拒绝\n
- 审计：控制面能看到至少：邀请码解析、会话开关、代理注册成功/失败原因

---

## 2. 阶段二：Beta（8-12 周）

### 2.1 交付目标

- 共享能力增强：邀请码更细粒度限制、可撤销、可视化统计。
- 域名与证书自动化（建议以 Caddy 为入口实现）。
- QoS 从“数量限制”扩展到“带宽/流量”。

### 2.2 功能清单

#### A) 域名/证书（控制面 + Caddy）

- 官方二级域名分配（HTTP/HTTPS 隧道）
- 用户自有域名绑定（DNS/HTTP challenge 校验）
- Caddy 自动签证书与续期（配置由控制面生成/下发）

#### B) QoS（控制面策略 + frps 执行）

- 带宽上限（invite/proxy 维度，token-bucket）
- 流量上限（按周期，超限拒绝新连接或断开/限速）

#### C) 监控与面板

- 节点健康：在线/离线/异常
- 连接与代理趋势图、失败原因分布\n

### 2.3 验收标准（Beta）

- HTTP/HTTPS：分配官方二级域名后可访问（证书自动）
- QoS：对指定 invite 限速生效并可观测

---

## 3. 阶段三：Launch（8-12 周）

> 本阶段仍不引入“用户注册”也能商业化：可以用“邀请码=套餐权益载体”，或引入“付款后下发特定邀请码”。如未来要做账号体系，可作为可选模块，不影响数据面。

### 3.1 交付目标

- 商业化与运营闭环（可选）：套餐、支付、计费、风控。\n
- 多区域与调度：就近推荐、自动下线、灰度发布。

### 3.2 功能清单（建议）

- 套餐与计费：按 invite 的带宽/流量/并发档位售卖
- 节点调度：基于 region/isp/健康/负载推荐
- 安全：滥用检测、封禁、速率限制\n

---

## 4. 风险与关键技术点（提前规避）

- **票据泄露**：短期 `exp` + 可撤销 invite + 频控；必要时绑定 client 指纹（可选）。
- **控制面成为瓶颈**：鉴权回调需要低延迟；建议内网部署、连接池、缓存策略（例如票据验签可缓存）。
- **端口池冲突**：需要“分配端口”时加锁或使用数据库事务保证唯一性。


